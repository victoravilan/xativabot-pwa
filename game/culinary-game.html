<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Sopa de Letras Gastron√≥mica</title>
<style>
  :root{
    --primary:#8B0000; --primary-dark:#6d0019; --accent:#27ae60;
    --bg:#fff8f6; --card:#ffffff; --text:#2c3e50;
    --yellow:#FFD166;
    --cellSize: clamp(28px, calc(100vw/14), 44px);
    --gap: 3px;
  }
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui, -apple-system, "Roboto", Arial, sans-serif;
    background: radial-gradient(1200px 600px at 10% -10%, #fff0ea, transparent 60%),
                radial-gradient(1000px 800px at 100% 10%, #ffe8e3, transparent 50%),
                #fffaf8;
    color:var(--text);
    -webkit-tap-highlight-color: transparent;
  }
  .wrap{max-width:980px;margin:0 auto;padding:env(safe-area-inset-top,18px) 18px 18px}
  .head{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    margin-bottom:12px; flex-wrap:wrap
  }
  .title{
    font-weight:800;letter-spacing:.2px;
    color:var(--primary);
    font-size:clamp(18px,3vw,22px)
  }
  .btn{
    appearance:none;border:none;cursor:pointer;border-radius:12px;
    padding:10px 14px;font-weight:700;
    background:linear-gradient(180deg,var(--primary) 0%,var(--primary-dark) 100%);
    color:var(--yellow); box-shadow:0 6px 20px rgba(139,0,0,.25);
  }
  .grid-card{
    background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);
    border:1px solid #f2dede; padding:12px
  }
  .grid-wrap{display:flex;gap:12px;align-items:flex-start}
  .grid{
    display:grid;gap:var(--gap);background:#fff5f5;border:1px dashed #f8d7da;padding:6px;border-radius:10px;
    grid-auto-rows: var(--cellSize); grid-template-columns: repeat(var(--cols,12), var(--cellSize));
    touch-action: none;                /* ‚Üê clave para t√°ctil */
    -ms-touch-action: none;
    overscroll-behavior: contain;
    user-select: none; -webkit-user-select:none; -webkit-touch-callout:none;
  }
  .cell{
    width:var(--cellSize);height:var(--cellSize);display:grid;place-items:center;
    font-weight:800;border-radius:8px;background:#fff;color:#222;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
    user-select:none
  }
  .cell.selected{background:#ffe0e0}
  .cell.found{background:#e9f9ef;color:#19692c}
  .side{
    min-width:260px;flex:1;background:var(--card);border-radius:12px;padding:10px 12px;
    border:1px solid #fde0e6
  }
  .word-list{display:flex;flex-wrap:wrap;gap:8px}
  .word-item{
    background:linear-gradient(180deg,#fff,#fff6);
    border:1px solid #f2dede;padding:8px 10px;border-radius:999px;
    color:var(--primary);font-weight:800;cursor:pointer
  }
  .word-item.found{
    text-decoration:line-through;background:#e9f9ef;color:#19692c;border-color:#d3f1dc
  }
  .info{
    margin-top:12px;background:#fffef8;border:1px solid #ffe6bf;border-radius:12px;padding:10px 12px
  }
  .stat{opacity:.8;font-size:.92rem;margin:8px 0}

  /* Responsive */
  @media (max-width: 720px){
    .grid-wrap{flex-direction:column}
    .side{width:100%}
  }

  /* Modal gen√©rico */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:end;z-index:20;padding:0 12px 12px}
  .modal.show{display:grid}
  .card{
    width:min(100%,680px);background:#fff;border-radius:18px 18px 16px 16px;
    padding:0; box-shadow:0 18px 60px rgba(0,0,0,.35); border:2px solid rgba(139,0,0,.15)
  }
  .card-head{
    background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
    color:var(--yellow); padding:12px 14px; border-radius:16px 16px 0 0;
    display:flex; align-items:center; justify-content:space-between; gap:10px
  }
  .card-title{font-weight:900;letter-spacing:.2px}
  .card-body{padding:14px}
  .closeBtn{
    appearance:none; border:none; background:rgba(255,255,255,.2); color:#fff;
    border-radius:10px; padding:8px 10px; cursor:pointer; font-size:18px; line-height:1
  }

  /* Modal promo (centrada) */
  .modal.center{place-items:center}
  .promo{
    display:flex;gap:10px;align-items:center;justify-content:space-between;background:#f8f1e9;border:1px dashed #d4af37;border-radius:12px;padding:10px 12px
  }
  .promo-code{font-weight:900;font-size:1.2rem;color:var(--primary)}
  .small{opacity:.85;font-size:.94rem}

  .noscroll{overflow:hidden; height:100%}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="title" id="gameTitle">Sopa de letras culinaria</div>
    <button class="btn" id="restartBtn">Reiniciar</button>
  </div>

  <div class="grid-card">
    <div class="grid-wrap">
      <div class="grid" id="grid" aria-label="Tablero de sopa de letras"></div>
      <div class="side">
        <div class="small" id="subtitle">Encuentra estas palabras:</div>
        <div class="word-list" id="wordList" aria-live="polite"></div>
        <div class="info" id="infoBox">Selecciona letras contiguas en l√≠nea recta. Al acertar, se abrir√° una ventana con la historia/mito del ingrediente.</div>
        <div class="stat" id="statBox">Progreso: <span id="foundCount">0</span>/<span id="totalCount">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal LORE -->
<div class="modal" id="loreModal" role="dialog" aria-modal="true" aria-labelledby="loreTitle">
  <div class="card">
    <div class="card-head">
      <div class="card-title" id="loreTitle">Historia del ingrediente</div>
      <button class="closeBtn" id="closeLore" aria-label="Cerrar">√ó</button>
    </div>
    <div class="card-body">
      <p id="loreText">‚Äî</p>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button class="btn" id="okLore">Entendido</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal PROMO -->
<div class="modal center" id="winModal" role="dialog" aria-modal="true" aria-labelledby="winTitle">
  <div class="card" style="border-radius:18px">
    <div class="card-head" style="border-radius:16px 16px 0 0">
      <div class="card-title" id="winTitle">üéâ ¬°Felicidades!</div>
      <button class="closeBtn" id="closeWin" aria-label="Cerrar">√ó</button>
    </div>
    <div class="card-body">
      <p id="winMsg" class="small">Has completado el reto. Aqu√≠ tienes tu c√≥digo promocional:</p>
      <div class="promo">
        <div class="promo-code" id="promoCode">XAT-ABC123</div>
        <button class="btn" id="copyBtn">Copiar</button>
      </div>
      <p class="small" id="winNote" style="margin-top:10px">Lo hemos guardado y se enviar√° junto a tu reserva.</p>
      <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
        <button class="btn" id="okWin">Aceptar</button>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || 'es').toLowerCase();
  const T = {
    es:{title:"Sopa de letras culinaria",find:"Encuentra estas palabras:",info:"Selecciona letras contiguas en l√≠nea recta. Al acertar, se abrir√° una ventana con la historia/mito del ingrediente.",progress:"Progreso:",lore:"Historia del ingrediente",understood:"Entendido",winTitle:"üéâ ¬°Felicidades!",winMsg:"Has completado el reto. Aqu√≠ tienes tu c√≥digo promocional:",winNote:"Lo hemos guardado y se enviar√° junto a tu reserva.",copy:"Copiar",restart:"Reiniciar"},
    en:{title:"Culinary Word Search",find:"Find these words:",info:"Select contiguous letters in a straight line. A window will show its story when you find one.",progress:"Progress:",lore:"Ingredient story",understood:"Got it",winTitle:"üéâ Congrats!",winMsg:"You nailed it. Here‚Äôs your promo code:",winNote:"We saved it and will attach it to your booking.",copy:"Copy",restart:"Restart"},
    ca:{title:"Sopa de lletres culin√†ria",find:"Troba aquestes paraules:",info:"Selecciona lletres contig√ºes en l√≠nia recta. En encertar, s‚Äôobrir√† una finestra amb la hist√≤ria del ingredient.",progress:"Progr√©s:",lore:"Hist√≤ria de l‚Äôingredient",understood:"Ent√©s",winTitle:"üéâ Enhorabona!",winMsg:"Ho has clavat. Codi promocional:",winNote:"S‚Äôha desat i s‚Äôadjuntar√† a la reserva.",copy:"Copiar",restart:"Reiniciar"}
  }[lang];
  qs('#gameTitle').textContent=T.title; qs('#subtitle').textContent=T.find; qs('#infoBox').textContent=T.info;
  qs('#statBox').firstChild.textContent=T.progress+' '; qs('#loreTitle').textContent=T.lore; qs('#okLore').textContent=T.understood;
  qs('#winTitle').textContent=T.winTitle; qs('#winMsg').textContent=T.winMsg; qs('#winNote').textContent=T.winNote;
  qs('#copyBtn').textContent=T.copy; qs('#restartBtn').textContent=T.restart;

  const WORDS=[
    { w:"ARROZ",   lore:"El socarrat es el tesoro del fondo: textura crujiente y sabor concentrado." },
    { w:"AZAFRAN", lore:"Oro rojo: da color y aroma floral; tostar levemente potencia su magia." },
    { w:"FIDEUA",  lore:"Nacida por azar en Gand√≠a cuando falt√≥ arroz. Fideos tostados, sabor marino." },
    { w:"TOMATE",  lore:"De sospechoso a rey de la huerta. En su d√≠a se crey√≥ venenoso en Europa." },
    { w:"AJO",     lore:"Humilde y poderoso: base de sofritos y alioli; sabor que manda callar." },
    { w:"PIMENTON",lore:"Dulce o picante, ahumado o no: define chorizos, guisos y arroces." },
    { w:"CALAMAR", lore:"Aliado perfecto en arroces de mar; tierno con cocci√≥n breve o larga." },
    { w:"ALMEJA",  lore:"Aporta yodo y salinidad suave; abierta al vapor, pura elegancia." },
    { w:"ROMERO",  lore:"Hierba mediterr√°nea resinosa; perfuma asados y patatas." },
    { w:"LIMON",   lore:"Acidez luminosa; equilibra grasas y refresca marinados." },
    { w:"ACEITE",  lore:"AOVE: frutado, amargo y picante ‚Äî el tri√°ngulo de la calidad." },
    { w:"PAELLA",  lore:"Icono valenciano: sofrito, caldo sabroso y reposo respetuoso." }
  ];

  const ROWS=12, COLS=12;
  const gridEl=qs('#grid'); gridEl.style.setProperty('--cols', COLS);
  const listEl=qs('#wordList'), infoEl=qs('#infoBox'), foundCountEl=qs('#foundCount'), totalCountEl=qs('#totalCount');
  const loreModal=qs('#loreModal'), loreText=qs('#loreText');
  const winModal=qs('#winModal'), promoCodeEl=qs('#promoCode');
  totalCountEl.textContent=WORDS.length;

  const grid = Array.from({length:ROWS}, ()=> Array(COLS).fill(null));
  const placed=[]; const found=new Set();

  let selecting=false, start=null, dir=null, trail=[];
  const DIRS = [ [0,1],[1,0],[11,1],[0,-1],[-1,0],[-1,-1],[1,-1],[-1,1] ]; // [1,1] estaba mal tipeado (11,1) ‚Üí corregimos abajo en uso
  // Corrige el typo anterior:
  DIRS[2]=[1,1];

  const ABC="ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ";
  function rand(n){return Math.floor(Math.random()*n)}
  function inBounds(r,c){return r>=0&&r<ROWS&&c>=0&&c<COLS}
  function sign(n){return n===0?0:(n>0?1:-1)}
  function qs(s){return document.querySelector(s)}
  function bodyNoScroll(on){document.documentElement.classList.toggle('noscroll',on);document.body.classList.toggle('noscroll',on)}

  function placeAll(){
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) grid[r][c]=null;
    placed.length=0; found.clear();
    for(const obj of WORDS){
      const W=norm(obj.w); let ok=false, tries=0;
      while(!ok && tries<600){
        tries++;
        const d=DIRS[rand(DIRS.length)];
        const r0=rand(ROWS), c0=rand(COLS);
        let r=r0,c=c0, valid=true;
        for(let i=0;i<W.length;i++){
          if(!inBounds(r,c)){valid=false;break}
          const cell=grid[r][c];
          if(cell && cell!==W[i]){valid=false;break}
          r+=d[0]; c+=d[1];
        }
        if(!valid) continue;
        r=r0; c=c0;
        for(let i=0;i<W.length;i++){ grid[r][c]=W[i]; r+=d[0]; c+=d[1]; }
        placed.push({w:W,start:[r0,c0],dir:d});
        ok=true;
      }
      if(!ok) console.warn('No pude colocar', obj.w);
    }
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){ if(!grid[r][c]) grid[r][c]=ABC[rand(ABC.length)] }
  }

  function draw(){
    gridEl.innerHTML='';
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const d=document.createElement('div');
        d.className='cell'; d.textContent=grid[r][c]; d.dataset.r=r; d.dataset.c=c;
        gridEl.appendChild(d);
      }
    }
    listEl.innerHTML='';
    for(const obj of WORDS){
      const b=document.createElement('button');
      b.className='word-item'; b.dataset.word=obj.w; b.textContent=obj.w;
      listEl.appendChild(b);
    }
    foundCountEl.textContent=found.size;
  }

  function reset(){
    placeAll(); draw(); infoEl.textContent=T.info; found.clear(); foundCountEl.textContent=found.size; hideLore(); hideWin();
  }

  function norm(s){return s.toUpperCase().replace(/[√Å√Ä]/g,'A').replace(/[√â√à]/g,'E').replace(/[√ç√å]/g,'I').replace(/[√ì√í]/g,'O').replace(/[√ö√ô]/g,'U')}
  function clearTrail(){ for(const el of trail) el.classList.remove('selected'); trail.length=0; }

  function cellAt(r,c){ const idx=r*COLS+c; return gridEl.children[idx]||null }
  function elementCellFromPoint(x,y){
    const el=document.elementFromPoint(x,y);
    if(!el) return null;
    const cell=el.closest('.cell');
    if(!cell) return null;
    return {el:cell, r:+cell.dataset.r, c:+cell.dataset.c};
  }
  function cellFromEvent(e){
    // Con pointer capture, target es el grid; usamos elementFromPoint
    return elementCellFromPoint(e.clientX, e.clientY);
  }

  function nearestDir(fromR,fromC,toR,toC){
    const dr=sign(toR-fromR), dc=sign(toC-fromC);
    if(dr===0 && dc===0) return null;
    // proyecta al conjunto de 8 dirs (dr,dc ‚àà {-1,0,1} \ {(0,0)})
    return {dr, dc};
  }

  function updateTrail(toR, toC){
    clearTrail();
    if(!start) return;
    if(!dir){
      const nd=nearestDir(start.r,start.c,toR,toC);
      if(!nd) return;
      dir = nd;
    }
    let r=start.r, c=start.c;
    while(true){
      const el=cellAt(r,c);
      if(el){ el.classList.add('selected'); trail.push(el); }
      if(r===toR && c===toC) break;
      r+=dir.dr; c+=dir.dc;
      if(!inBounds(r,c)) break;
      // si nos salimos del vector l√≥gico, paramos
      if (Math.sign(toR - r)!==dir.dr && Math.sign(toC - c)!==dir.dc) break;
    }
  }

  gridEl.addEventListener('pointerdown', e=>{
    const info=cellFromEvent(e); if(!info) return;
    e.preventDefault();
    selecting=true; start={r:info.r, c:info.c}; dir=null; clearTrail();
    info.el.classList.add('selected'); trail.push(info.el);
    bodyNoScroll(true);
    gridEl.setPointerCapture(e.pointerId);
  }, {passive:false});

  gridEl.addEventListener('pointermove', e=>{
    if(!selecting) return;
    e.preventDefault();
    const info=cellFromEvent(e); if(!info) return;
    updateTrail(info.r, info.c);
  }, {passive:false});

  function endSelection(e){
    if(!selecting) return;
    e && e.preventDefault();
    selecting=false; bodyNoScroll(false);
    if(e && e.pointerId) try{ gridEl.releasePointerCapture(e.pointerId);}catch{}
    finalizeSelection();
  }
  gridEl.addEventListener('pointerup', endSelection, {passive:false});
  gridEl.addEventListener('pointercancel', endSelection, {passive:false});
  gridEl.addEventListener('lostpointercapture', endSelection);

  function finalizeSelection(){
    if(!trail.length) return;
    const s=trail.map(x=>x.textContent).join('');
    const rev=trail.slice().reverse().map(x=>x.textContent).join('');
    let hit=null, forward=false;
    for(const obj of WORDS){
      const W=norm(obj.w);
      if(s===W){hit=obj; forward=true; break}
      if(rev===W){hit=obj; forward=false; break}
    }
    clearTrail(); dir=null; start=null;
    if(!hit) return;

    if(!found.has(hit.w)){
      const cells = cellsOfWord(hit.w, forward);
      cells.forEach(el=>el.classList.add('found'));
      const item=[...document.querySelectorAll('.word-item')].find(b=>b.dataset.word===hit.w);
      if(item) item.classList.add('found');
      found.add(hit.w); foundCountEl.textContent=found.size;
      showLore(hit.lore);
      if(found.size>=7){
        const code=getOrCreatePromo(); promoCodeEl.textContent=code; showWin();
        try{ parent.postMessage({type:'CULINARY_GAME_DONE', code, words:[...found], lang}, '*'); }catch{}
      }
    }
  }

  function cellsOfWord(word, forward){
    const target=norm(word);
    for(const plc of placed){
      if(plc.w!==target) continue;
      const out=[];
      let r=plc.start[0], c=plc.start[1];
      const d={dr:plc.dir[0], dc:plc.dir[1]};
      const len=plc.w.length;
      if(!forward){
        r=r + d.dr*(len-1); c=c + d.dc*(len-1);
        d.dr*=-1; d.dc*=-1;
      }
      for(let i=0;i<len;i++){ const el=cellAt(r,c); if(el) out.push(el); r+=d.dr; c+=d.dc; }
      return out;
    }
    return [];
  }

  function getOrCreatePromo(){
    const k='xativabot-game-promo';
    let v=localStorage.getItem(k);
    if(v) return v;
    v='XAT-' + Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6);
    localStorage.setItem(k,v);
    return v;
  }

  function showLore(txt){ loreText.textContent=txt; loreModal.classList.add('show'); }
  function hideLore(){ loreModal.classList.remove('show'); }
  qs('#closeLore').addEventListener('click', hideLore);
  qs('#okLore').addEventListener('click', hideLore);

  function showWin(){ winModal.classList.add('show'); }
  function hideWin(){ winModal.classList.remove('show'); }
  qs('#closeWin').addEventListener('click', hideWin);
  qs('#okWin').addEventListener('click', hideWin);
  qs('#copyBtn').addEventListener('click', ()=>{ const v=promoCodeEl.textContent.trim(); navigator.clipboard?.writeText(v); });

  qs('#restartBtn').addEventListener('click', reset);

  reset();
})();
</script>
</body>
</html>
