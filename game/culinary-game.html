<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Sopa de Letras Gastronómica · XativaBot</title>
  <meta name="theme-color" content="#8B0000" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --vino:#8B0000; --vino2:#5f0000; --dorado:#D4AF37;
      --bg:#ffffff; --tin:#222; --gap:6px; --cell:32px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Roboto,system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background:var(--bg); color:var(--tin);
      height:100svh; overflow:hidden; /* evita scroll de página en el juego */
    }

    .app {display:flex; flex-direction:column; height:100%;}
    .topbar{
      display:flex; align-items:center; gap:10px;
      background:linear-gradient(180deg,#990000,var(--vino)); color:#fff;
      padding:10px 12px; flex:0 0 auto;
    }
    .topbar a.back{
      text-decoration:none; color:#fff; background:#0000001a;
      border:1px solid #ffffff55; padding:8px 10px; border-radius:999px; font-weight:700;
    }
    .topbar h1{ margin:0; font-family:"Playfair Display",serif; font-size:clamp(18px,5vw,24px); }

    .main{ flex:1 1 auto; display:grid; gap:12px; grid-template-columns:1.1fr .9fr; padding:12px; min-height:0; }
    @media (max-width: 880px){ .main{ grid-template-columns:1fr; } }

    .panel, .words{
      background:#fff; border:1px solid #eee; border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.06); padding:12px; min-height:0;
    }

    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:10px}
    .stat{background:#fff;border:1px solid #eee;border-radius:12px;text-align:center;padding:8px}
    .big{font-weight:800;font-size:clamp(18px,5vw,24px);color:var(--vino)}
    .bar{height:8px;background:#eee;border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--dorado),#ffd463);transition:width .35s}

    .grid-outer{
      border:2px dashed #f6c7c7;border-radius:12px;padding:8px;background:linear-gradient(180deg,#fff7f7,#fff9f9);
      height: calc(100% - 80px); /* deja sitio a botones */
      min-height: 220px; overflow:auto; -webkit-overflow-scrolling: touch; overscroll-behavior: contain;
    }

    .grid{
      --cell: var(--cell, 32px);
      display:grid; gap:var(--gap); justify-content:center;
      touch-action:none; -webkit-user-select:none; user-select:none; contain:layout;
    }
    .cell{
      width: var(--cell); height: var(--cell);
      display:flex; align-items:center; justify-content:center;
      background:#fff; border-radius:10px; border:1px solid #e6e6e6; box-shadow:0 3px 10px rgba(0,0,0,.06);
      font-weight:800; letter-spacing:.6px; color:#2b3a4a; font-size:clamp(14px,4vw,18px);
    }
    .cell.active{outline:3px solid rgba(255,215,0,.65);background:#fff9dd}
    .cell.found{background:#1e7d3a;color:#fff;border-color:#16622d}

    .actions{display:flex;gap:10px;justify-content:space-between;margin-top:10px;flex-wrap:wrap}
    .btn{background:var(--vino);border:none;color:#fff;border-radius:10px;padding:10px 12px;font-weight:700;box-shadow:0 10px 24px rgba(139,0,0,.28);cursor:pointer}
    .btn.alt{background:#111}

    .words h3{font-family:"Playfair Display",serif;text-align:center;color:var(--vino);margin:2px 0 10px;font-size:clamp(18px,4.5vw,22px)}
    .list{display:grid;grid-template-columns:1fr 1fr;gap:10px; max-height: calc(100% - 42px); overflow:auto; padding-right:4px}
    @media (max-width:520px){ .list{grid-template-columns:1fr} }
    .chip{border:none;border-radius:999px;padding:10px 12px;font-weight:800;letter-spacing:.8px;background:linear-gradient(180deg,#b30c0c,#5f0000);color:#fff;box-shadow:0 8px 20px rgba(0,0,0,.14)}
    .chip.found{background:#1f9d55}

    .overlay{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.5);z-index:10;padding:10px}
    .overlay.show{display:flex}
    .sheet{width:100%;max-width:720px;background:#fff;border-radius:16px;border:2px solid #8b000022;box-shadow:0 30px 60px rgba(0,0,0,.35);padding:14px 16px;position:relative}
    .x{position:absolute;right:16px;top:12px;background:var(--vino);color:#fff;border:none;border-radius:999px;width:36px;height:36px;display:grid;place-items:center;font-weight:700}
    .sheet h2{font-family:"Playfair Display",serif;margin:6px 0 10px;color:var(--vino);font-size:clamp(18px,5vw,26px)}
    .desc{line-height:1.8;font-size:16px}

    /* botón volver fijo (ayuda en móviles) */
    .floating-back{
      position:fixed; left:12px; bottom:12px; z-index:11;
      background:#111; color:#fff; border:none; border-radius:999px; padding:10px 14px; font-weight:700;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <a class="back" href="index.html">← Volver</a>
      <h1>Sopa de Letras Gastronómica</h1>
    </div>

    <div class="main">
      <section class="panel">
        <div class="stats">
          <div class="stat"><div class="big" id="gm-found">0</div><div>Encontradas</div></div>
          <div class="stat"><div class="big" id="gm-total">—</div><div>Totales</div></div>
          <div class="stat"><div class="big" id="gm-pct">0%</div><div>Completado</div></div>
        </div>
        <div class="bar"><span id="gm-bar"></span></div>

        <div class="grid-outer" id="gm-wrap">
          <div id="gm-grid" class="grid" role="grid" aria-label="Sopa de letras"></div>
        </div>

        <div class="actions">
          <a class="btn alt" href="index.html">← Volver</a>
          <button class="btn" id="gm-restart">Reiniciar</button>
        </div>
      </section>

      <aside class="words">
        <h3>Ingredientes por descubrir</h3>
        <div id="gm-wordlist" class="list"></div>
      </aside>
    </div>
  </div>

  <button class="floating-back" onclick="location.href='index.html'">← Volver</button>

  <div id="story" class="overlay" aria-modal="true" role="dialog">
    <div class="sheet">
      <button class="x" id="story-x">✕</button>
      <h2 id="story-title">Título</h2>
      <div id="story-body" class="desc"></div>
    </div>
  </div>

  <script>
  /* Palabras + historias (puedes ampliar) */
  const WORDS = [
    { key:"CANELA", name:"Canela", story:"La canela proviene de la corteza interna del <i>Cinnamomum verum</i>. En la Antigüedad se valoraba como oro." },
    { key:"COMINO", name:"Comino", story:"Cálido y terroso; tostado breve despierta su aceite esencial. Ideal para legumbres y guisos." },
    { key:"CILANTRO", name:"Cilantro", story:"Las hojas aportan frescor cítrico (ceviches); las semillas, dulces, van en currys y panes." },
    { key:"JENGIBRE", name:"Jengibre", story:"Picante y fresco, da brillo cítrico a salteados, marinados e infusiones digestivas." },
    { key:"TOMATE", name:"Tomate", story:"Llegó de América; su umami es clave en sofritos y salsas mediterráneas." },
    { key:"BERENJENA", name:"Berenjena", story:"A la brasa o asada se vuelve sedosa; absorbe sabores como esponja." },
    { key:"QUINOA", name:"Quinoa", story:"Grano andino con proteína completa; perfecta en ensaladas y como guarnición." },
    { key:"CURCUMA", name:"Cúrcuma", story:"Raíz dorada; color y amargor amable. Imprescindible en currys y arroces especiados." },
    { key:"AGUACATE", name:"Aguacate", story:"Mantecoso y nutritivo; cremosidad y grasas cardiosaludables (guacamole)." },
    { key:"ALBAHACA", name:"Albahaca", story:"Herbácea anisada; base del pesto y amiga del tomate. Añadir al final." },
    { key:"ROMERO", name:"Romero", story:"Dominante si se abusa; va genial con carnes, patatas y panes." },
    { key:"VAINILLA", name:"Vainilla", story:"Orquídea cuyo fruto aromatiza cremas y bizcochos; mejor vaina que esencia." },
    { key:"NUEZMOSCADA", name:"Nuez moscada", story:"Rallada al momento para bechamel y purés; combina con espinacas." },
    { key:"PIMIENTA", name:"Pimienta", story:"Negra, blanca o verde: la reina de las especias. Finaliza salsas y carnes." }
  ];

  const GM = { size:14, grid:[], cells:[], placed:[], found:new Set(), selecting:false, start:null, path:[] };
  const el = {
    wrap: document.getElementById('gm-wrap'),
    grid: document.getElementById('gm-grid'),
    list: document.getElementById('gm-wordlist'),
    found: document.getElementById('gm-found'),
    total: document.getElementById('gm-total'),
    pct: document.getElementById('gm-pct'),
    bar: document.getElementById('gm-bar'),
    restart: document.getElementById('gm-restart'),
    story: document.getElementById('story'),
    storyX: document.getElementById('story-x'),
    title: document.getElementById('story-title'),
    body: document.getElementById('story-body')
  };

  const norm = s => s.normalize('NFD').replace(/\p{Diacritic}/gu,'').toUpperCase();
  const dirs = [[0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]];

  function canPlace(word,r,c,dr,dc){
    for(let i=0;i<word.length;i++){
      const rr=r+dr*i, cc=c+dc*i;
      if(rr<0||cc<0||rr>=GM.size||cc>=GM.size) return false;
      const ch=GM.grid[rr][cc];
      if(ch!=='' && ch!==word[i]) return false;
    }
    return true;
  }
  function placeWord(word){
    for(let k=0;k<300;k++){
      const [dr,dc]=dirs[(Math.random()*dirs.length)|0];
      const r=(Math.random()*GM.size)|0, c=(Math.random()*GM.size)|0;
      if (canPlace(word,r,c,dr,dc)){
        for(let i=0;i<word.length;i++) GM.grid[r+dr*i][c+dc*i]=word[i];
        return {r,c,dr,dc,len:word.length};
      }
    }
    return null;
  }
  function fillRandom(){
    const A='ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    for(let r=0;r<GM.size;r++){
      for(let c=0;c<GM.size;c++){
        if(!GM.grid[r][c]) GM.grid[r][c]=A[(Math.random()*A.length)|0];
      }
    }
  }

  function build(){
    GM.grid = Array.from({length:GM.size}, ()=> Array(GM.size).fill(''));
    GM.placed=[]; GM.found=new Set(); GM.selecting=false; GM.start=null; GM.path=[];
    for(const w of WORDS){
      const ok=placeWord(norm(w.key));
      if (ok) GM.placed.push({key:w.key, ...ok});
    }
    fillRandom();
    renderGrid();
    renderList();
    updateStats();
    fitGrid(); // ajuste inicial
  }

  function renderGrid(){
    el.grid.style.setProperty('--gap','6px');
    el.grid.style.gridTemplateColumns=`repeat(${GM.size}, minmax(18px, 1fr))`;
    el.grid.innerHTML=''; GM.cells=[];
    for(let r=0;r<GM.size;r++){
      for(let c=0;c<GM.size;c++){
        const d=document.createElement('button');
        d.className='cell'; d.type='button'; d.textContent=GM.grid[r][c];
        d.dataset.r=r; d.dataset.c=c; el.grid.appendChild(d); GM.cells.push(d);
      }
    }
    // eventos táctiles/ratón – bloquear desplazamiento de página
    el.grid.addEventListener('pointerdown', onDown, {passive:false});
    el.grid.addEventListener('pointermove', onMove, {passive:false});
    el.grid.addEventListener('pointerup', onUp, {passive:false});
    el.grid.addEventListener('pointercancel', onUp, {passive:false});
    el.grid.addEventListener('touchmove', e=>{ if(GM.selecting) e.preventDefault(); }, {passive:false});
  }

  function renderList(){
    el.list.innerHTML='';
    WORDS.forEach(w=>{
      const b=document.createElement('button');
      b.className='chip'; b.type='button';
      b.textContent=w.key.replace('NUEZMOSCADA','NUEZ MOSCADA');
      b.id=`w-${w.key}`;
      b.addEventListener('click',()=> showStory(w.name,w.story));
      el.list.appendChild(b);
    });
    document.getElementById('gm-total').textContent = WORDS.length;
  }

  function updateStats(){
    const n=GM.found.size;
    el.found.textContent=n;
    const pct=Math.round(n*100/WORDS.length);
    el.pct.textContent=pct+'%';
    el.bar.style.width=pct+'%';
  }

  // ===== Ajuste dinámico del tamaño de celdas =====
  function fitGrid(){
    // tamaño máximo que cabe en el contenedor visible
    const wrapRect = el.wrap.getBoundingClientRect();
    const cols = GM.size, rows = GM.size;
    const gap = 6;

    // Anchura y altura disponibles
    const W = Math.max(120, wrapRect.width - gap*(cols-1));
    const H = Math.max(120, wrapRect.height - gap*(rows-1));

    // Tamaño de celda que cabe sin overflow
    const cellW = Math.floor(W / cols);
    const cellH = Math.floor(H / rows);
    const cell = Math.max(18, Math.min(cellW, cellH, 44)); // clamp 18–44px

    el.grid.style.setProperty('--cell', cell + 'px');
  }

  window.addEventListener('resize', ()=>{ fitGrid(); }, {passive:true});
  window.addEventListener('orientationchange', ()=>{ setTimeout(fitGrid, 250); }, {passive:true});
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(fitGrid, 150); });

  // ===== Selección de palabras =====
  function elementFromEvent(ev){
    const pt = ('clientX' in ev) ? {x:ev.clientX,y:ev.clientY} : {x:ev.touches[0].clientX, y:ev.touches[0].clientY};
    const elx = document.elementFromPoint(pt.x, pt.y);
    return (elx && elx.classList.contains('cell')) ? elx : null;
  }
  function line(r0,c0,r1,c1){
    const dr=Math.sign(r1-r0), dc=Math.sign(c1-c0);
    if(!(dr===0||dc===0||Math.abs(r1-r0)===Math.abs(c1-c0))){
      const ar=Math.abs(r1-r0), ac=Math.abs(c1-c0);
      if(ar>ac){ c1=c0+(r1>r0? ar : -ar)*Math.sign(c1-c0||1); }
      else     { r1=r0+(c1>c0? ac : -ac)*Math.sign(r1-r0||1); }
    }
    const DR=Math.sign(r1-r0), DC=Math.sign(c1-c0);
    const out=[]; let r=r0,c=c0; out.push({r,c});
    while(r!==r1||c!==c1){ r+=DR; c+=DC; if(r<0||c<0||r>=GM.size||c>=GM.size) break; out.push({r,c}); }
    return out;
  }
  function clearActive(){ GM.cells.forEach(d=>d.classList.remove('active')); }
  function markActive(path){ clearActive(); path.forEach(p=> document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`)?.classList.add('active')); }
  function markFound(path){ path.forEach(p=> document.querySelector(`.cell[data-r="${p.r}"][data-c="${p.c}"]`)?.classList.add('found')); }

  function onDown(e){
    e.preventDefault();
    GM.selecting=true;
    const cell = elementFromEvent(e); if(!cell) return;
    GM.start = { r:+cell.dataset.r, c:+cell.dataset.c };
    GM.path=[GM.start]; markActive(GM.path);
  }
  function onMove(e){
    if(!GM.selecting) return;
    e.preventDefault();
    const cell = elementFromEvent(e); if(!cell) return;
    const r=+cell.dataset.r, c=+cell.dataset.c;
    GM.path = line(GM.start.r, GM.start.c, r, c);
    markActive(GM.path);
  }
  function onUp(e){
    if(!GM.selecting) return;
    GM.selecting=false;
    if(!GM.path || GM.path.length<2){ clearActive(); return; }
    const text = GM.path.map(p=> GM.grid[p.r][p.c]).join('');
    const tNorm = norm(text), tRev = norm(text.split('').reverse().join(''));
    const hit = WORDS.find(w => tNorm===norm(w.key) || tRev===norm(w.key));
    if(hit && !GM.found.has(hit.key)){
      GM.found.add(hit.key);
      markFound(GM.path);
      document.getElementById(`w-${hit.key}`)?.classList.add('found');
      updateStats();
      showStory(hit.name, hit.story);
      maybePromo();
    }
    clearActive();
  }

  // ===== Historias (modal) =====
  function showStory(title, html){
    el.title.textContent = title;
    el.body.innerHTML = html;
    el.story.classList.add('show');
  }
  el.storyX.addEventListener('click', ()=> el.story.classList.remove('show'));
  el.story.addEventListener('click', e=>{ if(e.target===el.story) el.story.classList.remove('show'); });

  // ===== Código promo al llegar a 7 hallazgos =====
  function genCode(){
    const s='abcdefghjkmnpqrstuvwxyz23456789'; let out='';
    for(let i=0;i<8;i++) out+= s[(Math.random()*s.length)|0];
    return out;
  }
  function maybePromo(){
    if(GM.found.size < 7) return;
    const existing = localStorage.getItem('xativabot-promo-code');
    if(existing) return;
    const code = genCode();
    localStorage.setItem('xativabot-promo-code', code);
    const payload = { when:new Date().toISOString(), found:Array.from(GM.found), code };
    localStorage.setItem('xativabot-game', JSON.stringify(payload));
    try{
      if (window.parent && window.parent !== window) window.parent.postMessage({type:'xativabot:promo', code}, '*');
      if (window.opener && !window.opener.closed) window.opener.postMessage({type:'xativabot:promo', code}, '*');
    }catch{}
    alert('🎉 ¡Código promocional: '+code+'! Se añadirá a tu reserva.');
  }

  document.getElementById('gm-restart').addEventListener('click', build);

  // Inicializa
  build();
  // Ajuste adicional por si Safari tarda en pintar
  setTimeout(fitGrid, 200);
  </script>
</body>
</html>
