<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Xativa ¬∑ Sopa de letras culinaria</title>
<style>
  :root{
    --primary:#8B0000; /* rojo X√†tiva */
    --accent:#D4AF37;  /* dorado */
    --bg:#faf7f3;
    --card:#fff;
    --ink:#222;
    --muted:#666;
    --ok:#2e7d32;
    --warn:#ad1457;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    background:var(--bg); color:var(--ink);
  }
  .wrap{
    max-width:1100px; margin:0 auto; padding:14px; height:100%; display:flex; flex-direction:column; gap:12px;
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  h1{ font-size:20px; margin:0; display:flex; align-items:center; gap:8px; }
  .hint{ color:var(--muted); font-size:14px; }
  .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  button{
    appearance:none; border:0; background:var(--primary); color:#fff; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600;
    box-shadow:0 6px 16px rgba(139,0,0,.25);
  }
  button.secondary{ background:#111; }
  button.ghost{ background:#fff; color:#111; border:1px solid #ddd; box-shadow:none; }
  main{ display:grid; grid-template-columns: 1fr 320px; gap:14px; flex:1; min-height:0; }
  @media (max-width: 900px){ main{ grid-template-columns: 1fr; } }
  .board{
    background:var(--card); border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.08); padding:12px; display:flex; flex-direction:column; gap:10px; min-height:0;
  }
  .grid{
    user-select:none; -webkit-user-select:none;
    display:grid; gap:4px; padding:6px; background:#fff; border-radius:10px; border:1px solid #eee;
    touch-action:none;
  }
  .cell{
    width:32px; height:32px; display:flex; align-items:center; justify-content:center;
    font-weight:700; font-size:16px; border-radius:6px; background:#f7f7f7; color:#111; border:1px solid #eee;
    transition:background .1s, transform .06s;
  }
  .cell:hover{ transform:translateY(-1px); }
  .cell.active{ background:#ffe3e3; border-color:#f2b2b2; }
  .cell.found{ background:#e7f6ea; border-color:#b9e2c0; color:#0b3d0b; }
  .wordlist{
    display:flex; gap:8px; flex-wrap:wrap; margin:4px 2px 0;
  }
  .wtag{
    padding:6px 10px; font-size:13px; border-radius:999px; background:#f1f1f1; border:1px solid #e5e5e5; color:#333;
  }
  .wtag.ok{ background:#e8f5e9; border-color:#c8e6c9; color:#1b5e20; text-decoration:line-through; }
  .side{
    background:var(--card); border-radius:14px; box-shadow:0 10px 28px rgba(0,0,0,.08); padding:12px; display:flex; flex-direction:column; gap:10px; min-height:0;
  }
  .side h3{ margin:0 0 6px; font-size:16px; }
  .log{
    flex:1; overflow:auto; border:1px solid #eee; border-radius:10px; padding:10px; background:#fff;
  }
  .fact{
    border-left:4px solid var(--accent); background:#fff8e6; padding:8px 10px; border-radius:8px; margin:0 0 10px;
  }
  .fact h4{ margin:0 0 4px; font-size:14px; }
  .fact p{ margin:0; font-size:13px; color:#333; }
  .progress{ font-size:14px; color:#333; }
  .promo{
    display:none; background:#fff; border:2px dashed var(--accent); color:#111; padding:10px; border-radius:10px; font-weight:700;
  }
  .promo.show{ display:block; }
  footer{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .badge{ background:#ffe9a8; color:#5c4200; padding:6px 10px; border-radius:10px; border:1px solid #f1d37a; font-weight:600; }
  /* Modal */
  .modal[hidden]{ display:none; }
  .modal{
    position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:1000; padding:16px;
  }
  .modal > .card{
    width:min(520px, 100%); background:#fff; border-radius:16px; padding:18px; text-align:center;
    box-shadow:0 20px 60px rgba(0,0,0,.35);
  }
  .modal h2{ margin:0 0 8px; }
  .code{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:18px; letter-spacing:1px; padding:10px 12px; border-radius:10px; background:#111; color:#fff; display:inline-block; margin:6px 0 10px;
  }
  .small{ font-size:12px; color:#666; }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>üç≤ <span data-i="title">Sopa de letras culinaria</span></h1>
      <div class="hint" data-i="hint">Arrastra o toca desde una letra inicial hasta la final (horizontal, vertical o diagonal). Encuentra 7 para desbloquear tu c√≥digo.</div>
    </div>
    <div class="controls">
      <button id="newGameBtn" class="ghost" data-i="newgame">Nueva partida</button>
    </div>
  </header>

  <main>
    <section class="board">
      <div class="wordlist" id="wordList"></div>
      <div class="grid" id="grid"></div>
      <div class="progress" id="progress"></div>
      <div class="promo" id="promoBox"></div>
    </section>

    <aside class="side">
      <h3 data-i="stories">Historias y notas</h3>
      <div class="log" id="log"></div>
    </aside>
  </main>

  <footer>
    <div class="badge" id="statusBadge">Ready</div>
    <div class="hint small" data-i="footer">Completa 7 palabras para tu sorpresa gastron√≥mica.</div>
  </footer>
</div>

<!-- Modal promoci√≥n -->
<div id="promoModal" class="modal" hidden>
  <div class="card">
    <h2 data-i="congrats">¬°Felicidades!</h2>
    <p data-i="unlocked">Has desbloqueado tu c√≥digo promocional para la reserva:</p>
    <div class="code" id="promoCodeBox">XATIVA-FOOD-0000</div>
    <p class="small" data-i="savehint">Lo guardaremos y lo a√±adiremos autom√°ticamente a tu reserva.</p>
    <div style="margin-top:10px">
      <button id="closeModalBtn" class="secondary" data-i="close">Cerrar</button>
    </div>
  </div>
</div>

<script>
(function(){
  // ========= i18n b√°sico =========
  const UI = {
    es: {
      title: "Sopa de letras culinaria",
      hint: "Arrastra o toca desde una letra inicial hasta la final (horizontal, vertical o diagonal). Encuentra 7 para desbloquear tu c√≥digo.",
      newgame: "Nueva partida",
      stories: "Historias y notas",
      footer: "Completa 7 palabras para tu sorpresa gastron√≥mica.",
      found_of: (a,b)=>`Encontradas ${a} de ${b}`,
      congrats: "¬°Felicidades!",
      unlocked: "Has desbloqueado tu c√≥digo promocional para la reserva:",
      savehint: "Lo guardaremos y lo a√±adiremos autom√°ticamente a tu reserva.",
      close: "Cerrar",
      codeReady: (c)=>`üéâ C√≥digo promocional listo: ${c}`,
    },
    en: {
      title: "Culinary Word Hunt",
      hint: "Drag or tap from a start letter to the end (horizontal, vertical or diagonal). Find 7 to unlock your code.",
      newgame: "New game",
      stories: "Stories & notes",
      footer: "Find 7 words to unlock your culinary surprise.",
      found_of: (a,b)=>`Found ${a} of ${b}`,
      congrats: "Congratulations!",
      unlocked: "You've unlocked your promotional code for the booking:",
      savehint: "We‚Äôll store it and add it to your reservation automatically.",
      close: "Close",
      codeReady: (c)=>`üéâ Promo code ready: ${c}`,
    },
    ca: {
      title: "Sopa de lletres culin√†ria",
      hint: "Arrossega o toca des d‚Äôuna lletra inicial fins a la final (horitzontal, vertical o diagonal). Troba‚Äôn 7 per a desbloquejar el codi.",
      newgame: "Nova partida",
      stories: "Hist√≤ries i notes",
      footer: "Completa 7 paraules per a la teua sorpresa gastron√≤mica.",
      found_of: (a,b)=>`Trobades ${a} de ${b}`,
      congrats: "Felicitats!",
      unlocked: "Has desbloquejat el teu codi promocional per a la reserva:",
      savehint: "El desarem i l‚Äôafegirem autom√†ticament a la reserva.",
      close: "Tancar",
      codeReady: (c)=>`üéâ Codi promocional llest: ${c}`,
    }
  };
  const lang = (new URL(location.href).searchParams.get('lang') || navigator.language || 'es').slice(0,2);
  const L = UI[lang] || UI.es;
  document.querySelectorAll('[data-i]').forEach(el=>{
    const key = el.getAttribute('data-i');
    if (typeof L[key] === 'string') el.textContent = L[key];
  });

  // ========= Datos del juego =========
  // Palabras sin acentos y en may√∫sculas para l√≥gica; mostramos con tildes cuando proceda
  const WORDS = [
    // word, display
    ["ARROZ","ARROZ"],
    ["AZAFRAN","AZAFR√ÅN"],
    ["ACEITE","ACEITE"],
    ["SOFRITO","SOFRITO"],
    ["SOCARRAT","SOCARRAT"],
    ["PAELLA","PAELLA"],
    ["FIDEUA","FIDEU√Ä"],
    ["ALLIPEBRE","ALL I PEBRE"],
    ["CALDO","CALDO"],
    ["TOMATE","TOMATE"],
    ["AJO","AJO"],
    ["PIMENTON","PIMENT√ìN"],
    ["MARISCO","MARISCO"],
    ["GAMBAS","GAMBAS"],
    ["CALAMAR","CALAMAR"]
  ];
  const TARGET_TO_UNLOCK = 7;

  // Historias/mitos/notas por palabra (ES/EN/CA muy conciso)
  const INFO = {
    ARROZ:{
      es:"Base de la paella: variedades bomba o s√©nia absorben caldo sin romperse; el ‚Äòsocarrat‚Äô es el final crujiente y deseado.",
      en:"Paella‚Äôs base: bomba or senia rice absorbs stock without bursting; the ‚Äòsocarrat‚Äô is the prized crispy bottom.",
      ca:"Base de la paella: varietats bomba o s√©nia absorbeixen brou sense trencar-se; el ‚Äòsocarrat‚Äô √©s el final cruixent i desitjat."
    },
    AZAFRAN:{
      es:"Oro rojo mediterr√°neo: estigmas del Crocus sativus; aporta aroma floral y color dorado.",
      en:"Mediterranean ‚Äòred gold‚Äô: stigmas of Crocus sativus; floral aroma and golden hue.",
      ca:"‚ÄòOr roig‚Äô mediterrani: estigmes del Crocus sativus; aroma floral i color daurat."
    },
    ACEITE:{
      es:"El AOVE sustenta sofritos y ali√±os; su frutado, amargor y picor var√≠an seg√∫n la variedad y el terroir.",
      en:"Extra virgin olive oil grounds sofritos and dressings; fruitiness, bitterness and pungency vary by cultivar and terroir.",
      ca:"L‚Äôoli d‚Äôoliva verge extra sost√© sofregits i amanides; el fruitat, l‚Äôamargor i el picant varien segons la varietat i el terrer."
    },
    SOFRITO:{
      es:"T√©cnica de cocci√≥n lenta de hortalizas en grasa: construye profundidad y dulzor en arroces y guisos.",
      en:"Slow cooking technique of vegetables in fat: builds depth and sweetness in rice and stews.",
      ca:"T√®cnica de cocci√≥ lenta d‚Äôhortalisses en greix: construeix profunditat i dol√ßor en arrossos i guisats."
    },
    SOCARRAT:{
      es:"Capa tostada al fondo de la paella; se logra con calor final controlado y caldo justo.",
      en:"Toasted layer at the pan‚Äôs bottom; achieved with controlled finishing heat and just enough stock.",
      ca:"Capa torrada al fons de la paella; s‚Äôaconsegueix amb calor final controlada i brou just."
    },
    PAELLA:{
      es:"Icono valenciano: equilibrio entre caldo, arroz y fuego. Tradici√≥n de domingo y reuni√≥n.",
      en:"Valencian icon: balance of stock, rice and fire. A Sunday and gathering tradition.",
      ca:"Icona valenciana: equilibri entre brou, arr√≤s i foc. Tradici√≥ de diumenge i reuni√≥."
    },
    FIDEUA:{
      es:"Nacida en Gand√≠a: fideos dorados en paella con caldo de pescado; textura melosa.",
      en:"Born in Gand√≠a: noodles toasted in paella pan with fish stock; luscious texture.",
      ca:"Nascuda a Gandia: fideus daurats en paella amb brou de peix; textura melosa."
    },
    ALLIPEBRE:{
      es:"Guiso tradicional de anguila con ajo y piment√≥n en la Albufera.",
      en:"Traditional eel stew with garlic and paprika from the Albufera.",
      ca:"Guisat tradicional d‚Äôanguila amb all i pebre a l‚ÄôAlbufera."
    },
    CALDO:{
      es:"El alma del arroz: potencia sabor y transfiere gelatina; limpia o tostada seg√∫n estilo.",
      en:"The soul of rice: drives flavor and transfers gelatin; clear or roasted style.",
      ca:"L‚Äô√†nima de l‚Äôarr√≤s: potencia sabor i transfereix gelatina; clar o torrat segons l‚Äôestil."
    },
    TOMATE:{
      es:"Acidez y umami en sofritos; maduraci√≥n y variedad determinan dulzor.",
      en:"Acidity and umami in sofritos; ripeness and cultivar define sweetness.",
      ca:"Acidesa i umami en sofregits; maduraci√≥ i varietat determinen dol√ßor."
    },
    AJO:{
      es:"Pilar arom√°tico; crudo es picante, confitado aporta dulzor y cremosidad.",
      en:"Aromatic pillar; raw is pungent, confited is sweet and creamy.",
      ca:"Pilar arom√†tic; cru √©s picant, confitat aporta dol√ßor i cremositat."
    },
    PIMENTON:{
      es:"Dulce o picante; tostado brevemente libera color y perfume, cuidado con amargar.",
      en:"Sweet or hot; briefly toasted releases color and perfume, beware of bitterness.",
      ca:"Dol√ß o picant; lleugerament torrat allibera color i perfum, compte amb l‚Äôamargor."
    },
    MARISCO:{
      es:"Aporta yodo y dulzor marino; cocinar poco para mantener textura firme.",
      en:"Brings iodine and oceanic sweetness; cook lightly to keep firm texture.",
      ca:"Aporta iode i dol√ßor marina; coure poc per mantindre textura ferma."
    },
    GAMBAS:{
      es:"Cabezas para salsas intensas; vuelta y vuelta para caramelo y jugosidad.",
      en:"Heads for intense sauces; quick sear for caramelization and juiciness.",
      ca:"Caps per a salses intenses; volta i volta per a caramel i sucul√®ncia."
    },
    CALAMAR:{
      es:"O muy breve o muy largo: regla del calamar para ternura; tinta para arroces.",
      en:"Very short or very long: squid rule for tenderness; ink enriches rice dishes.",
      ca:"O molt breu o molt llarg: regla del calamar per a tendresa; tinta per a arrossos."
    }
  };

  // ========= Estado =========
  const gridEl = document.getElementById('grid');
  const wordListEl = document.getElementById('wordList');
  const logEl = document.getElementById('log');
  const progressEl = document.getElementById('progress');
  const statusBadge = document.getElementById('statusBadge');
  const promoBox = document.getElementById('promoBox');
  const promoModal = document.getElementById('promoModal');
  const promoCodeBox = document.getElementById('promoCodeBox');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const newGameBtn = document.getElementById('newGameBtn');

  const SIZE = 12;
  let GRID = [];
  let OCC = []; // ocupaci√≥n con ids de palabra
  let PLACED = []; // {word, display, cells:[{r,c}]}
  let FOUND = new Set();
  let selecting = false;
  let startCell = null;
  let currentPath = [];

  // ========= Utilidades =========
  function randInt(n){ return Math.floor(Math.random()*n); }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=randInt(i+1); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function normDir(dr,dc){
    const g = (x)=> x===0?0 : (x>0?1:-1);
    dr = g(dr); dc = g(dc);
    if (dr!==0 && dc!==0){ /* diag ok */ }
    return {dr, dc};
  }
  function inBounds(r,c){ return r>=0 && r<SIZE && c>=0 && c<SIZE; }
  function sanitize(s){ return s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().replace(/[^A-Z]/g,''); }

  // ========= Construcci√≥n del tablero =========
  function newGrid(){
    GRID = Array.from({length:SIZE},()=>Array(SIZE).fill(''));
    OCC  = Array.from({length:SIZE},()=>Array(SIZE).fill(null));
    PLACED = [];
    FOUND.clear();
    gridEl.className = 'grid';
    gridEl.style.gridTemplateColumns = `repeat(${SIZE}, 32px)`;
    logEl.innerHTML='';
    promoBox.classList.remove('show');

    // Colocar palabras
    const words = shuffle(WORDS.slice());
    words.forEach(([raw, display])=>{
      placeWord(raw, display);
    });

    // Rellenar huecos
    const ABC = "ABCDEFGHIJKLMN√ëOPQRSTUVWXYZ";
    for(let r=0;r<SIZE;r++){
      for(let c=0;c<SIZE;c++){
        if (!GRID[r][c]) GRID[r][c] = ABC[randInt(ABC.length)];
      }
    }

    renderGrid();
    renderWordList();
    updateProgress();
    statusBadge.textContent = 'Ready';
  }

  function placeWord(raw, display){
    const W = sanitize(raw);
    const len = W.length;
    const dirs = shuffle([
      {dr:0,dc:1}, {dr:0,dc:-1},
      {dr:1,dc:0}, {dr:-1,dc:0},
      {dr:1,dc:1}, {dr:1,dc:-1}, {dr:-1,dc:1}, {dr:-1,dc:-1}
    ]);
    for (const {dr,dc} of dirs){
      // posiciones posibles
      for (let tries=0; tries<200; tries++){
        const sr = randInt(SIZE), sc = randInt(SIZE);
        const er = sr + dr*(len-1), ec = sc + dc*(len-1);
        if (!inBounds(er,ec)) continue;
        let ok = true;
        for (let i=0;i<len;i++){
          const r = sr + dr*i, c = sc + dc*i;
          const ch = GRID[r][c];
          if (ch && ch !== W[i]) { ok = false; break; }
        }
        if (!ok) continue;
        // escribir
        const cells = [];
        for (let i=0;i<len;i++){
          const r = sr + dr*i, c = sc + dc*i;
          GRID[r][c] = W[i];
          OCC[r][c] = W; // id por palabra
          cells.push({r,c});
        }
        PLACED.push({word:W, display, cells});
        return true;
      }
    }
    return false;
  }

  function renderGrid(){
    gridEl.innerHTML = '';
    for(let r=0;r<SIZE;r++){
      for(let c=0;c<SIZE;c++){
        const div = document.createElement('div');
        div.className = 'cell';
        div.textContent = GRID[r][c] || '';
        div.dataset.r = r; div.dataset.c = c;
        gridEl.appendChild(div);
      }
    }
  }
  function renderWordList(){
    wordListEl.innerHTML = '';
    PLACED.forEach(p=>{
      const tag = document.createElement('div');
      tag.className = 'wtag';
      tag.textContent = p.display;
      tag.id = 'wtag_'+p.word;
      wordListEl.appendChild(tag);
    });
  }

  // ========= Selecci√≥n (rat√≥n/t√°ctil) =========
  gridEl.addEventListener('pointerdown', (e)=>{
    const cell = e.target.closest('.cell'); if (!cell) return;
    gridEl.setPointerCapture(e.pointerId);
    selecting = true;
    clearActivePath();
    startCell = cell;
    currentPath = [cell];
    cell.classList.add('active');
  });
  gridEl.addEventListener('pointermove', (e)=>{
    if (!selecting) return;
    const cell = document.elementFromPoint(e.clientX, e.clientY)?.closest?.('.cell');
    if (!cell || !gridEl.contains(cell)) return;
    if (currentPath[currentPath.length-1] === cell) return;
    // recalcular l√≠nea entre startCell y cell con direcci√≥n normalizada
    const sr = +startCell.dataset.r, sc = +startCell.dataset.c;
    const er = +cell.dataset.r, ec = +cell.dataset.c;
    const {dr,dc} = normDir(er - sr, ec - sc);
    if (dr === 0 && dc === 0) return;
    // construir path
    clearActivePath();
    currentPath = [];
    let r = sr, c = sc;
    while (inBounds(r,c)) {
      currentPath.push(getCellAt(r,c));
      if (r===er && c===ec) break;
      r += dr; c += dc;
    }
    currentPath.forEach(el=> el.classList.add('active'));
  });
  gridEl.addEventListener('pointerup', (e)=>{
    if (!selecting) return;
    selecting = false;
    gridEl.releasePointerCapture(e.pointerId);
    checkSelection();
    clearActivePath();
    startCell = null;
    currentPath = [];
  });

  function getCellAt(r,c){
    return gridEl.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
  }
  function clearActivePath(){
    currentPath.forEach(el=> el.classList.remove('active'));
  }

  function checkSelection(){
    if (!currentPath.length) return;
    const letters = currentPath.map(el=> el.textContent).join('');
    const rev = letters.split('').reverse().join('');
    // Comparar con palabras colocadas
    const hit = PLACED.find(p=>{
      const s = p.word;
      return s === letters || s === rev;
    });
    if (!hit) {
      statusBadge.textContent = '‚Äî';
      return;
    }
    if (FOUND.has(hit.word)) {
      statusBadge.textContent = '‚úì';
      return;
    }
    // Marcar found
    FOUND.add(hit.word);
    hit.cells.forEach(({r,c})=> getCellAt(r,c).classList.add('found'));
    const chip = document.getElementById('wtag_'+hit.word);
    if (chip) chip.classList.add('ok');

    // Log historia
    const fact = document.createElement('div');
    fact.className = 'fact';
    const title = document.createElement('h4'); title.textContent = hit.display;
    const p = document.createElement('p'); p.textContent = (INFO[hit.word] && (INFO[hit.word][lang] || INFO[hit.word].es)) || '';
    fact.appendChild(title); fact.appendChild(p);
    logEl.prepend(fact);

    updateProgress();
    statusBadge.textContent = '¬°Bien!';
    maybeUnlockPromo();
  }

  function updateProgress(){
    const total = PLACED.length;
    const found = FOUND.size;
    progressEl.textContent = L.found_of(found, total);
  }

  // ========= Promoci√≥n =========
  function maybeUnlockPromo(){
    if (FOUND.size >= TARGET_TO_UNLOCK && !localStorage.getItem('xativa_promo')){
      const code = makePromoCode();
      try { localStorage.setItem('xativa_promo', code); } catch {}
      // Mensaje al padre (app)
      try {
        window.parent.postMessage({ type:'xativaPromo', promoCode: code, words: Array.from(FOUND) }, '*');
      } catch {}
      // Mostrar modal
      promoCodeBox.textContent = code;
      promoModal.hidden = false;
      // Caja info en tablero
      promoBox.textContent = L.codeReady(code);
      promoBox.classList.add('show');
    }
  }
  function makePromoCode(){
    const n = Math.floor(1000 + Math.random()*9000);
    return `XATIVA-FOOD-${n}`;
  }
  closeModalBtn.addEventListener('click', ()=> promoModal.hidden = true);

  // ========= Nueva partida =========
  newGameBtn.addEventListener('click', ()=>{
    newGrid();
    statusBadge.textContent = 'Ready';
  });

  // ========= Start =========
  newGrid();

})();
</script>
</body>
</html>
