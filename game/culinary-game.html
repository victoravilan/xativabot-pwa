<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sopa de Letras GastronÃ³mica</title>
<style>
  :root{
    --primary:#8B0000; --primary-dark:#6d0019; --accent:#27ae60;
    --bg:#fff8f6; --card:#ffffff; --text:#2c3e50;
  }
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui, -apple-system, "Roboto", Arial, sans-serif;
    background: radial-gradient(1200px 600px at 10% -10%, #fff0ea, transparent 60%),
                radial-gradient(1000px 800px at 100% 10%, #ffe8e3, transparent 50%),
                #fffaf8;
    color:var(--text);
  }
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  .head{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    margin-bottom:12px
  }
  .title{
    font-weight:800;letter-spacing:.2px;
    color:var(--primary);
    font-size:clamp(18px,3vw,22px)
  }
  .btn{
    appearance:none;border:none;cursor:pointer;border-radius:12px;
    padding:10px 14px;font-weight:700;
    background:linear-gradient(180deg,var(--primary) 0%,var(--primary-dark) 100%);
    color:#fff; box-shadow:0 6px 20px rgba(139,0,0,.25);
  }
  .grid-card{
    background:var(--card);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.08);
    border:1px solid #f2dede; padding:12px
  }
  .grid-wrap{display:flex;gap:12px;flex-wrap:wrap}
  .grid{
    display:grid;gap:3px;background:#fff5f5;border:1px dashed #f8d7da;padding:6px;border-radius:10px
  }
  .cell{
    width:32px;height:32px;display:grid;place-items:center;
    font-weight:700;border-radius:6px;background:#fff;color:#333;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
    user-select:none
  }
  .cell.selected{background:#ffe0e0}
  .cell.found{background:#e9f9ef;color:#19692c}
  .side{
    min-width:260px;flex:1;background:var(--card);border-radius:12px;padding:10px 12px;
    border:1px solid #fde0e6
  }
  .word-list{display:flex;flex-wrap:wrap;gap:8px}
  .word-item{
    background:linear-gradient(180deg,#fff,#fff6);
    border:1px solid #f2dede;padding:8px 10px;border-radius:999px;
    color:var(--primary);font-weight:700;cursor:pointer
  }
  .word-item.found{
    text-decoration:line-through;background:#e9f9ef;color:#19692c;border-color:#d3f1dc
  }
  .info{
    margin-top:12px;background:#fffef8;border:1px solid #ffe6bf;border-radius:12px;padding:10px 12px
  }
  .stat{opacity:.8;font-size:.92rem;margin:8px 0}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;z-index:10;padding:16px}
  .modal.show{display:grid}
  .card{
    width:min(100%,560px);background:#fff;border-radius:18px;padding:16px 16px 18px;
    box-shadow:0 18px 60px rgba(0,0,0,.25);border:2px solid rgba(139,0,0,.15)
  }
  .promo{
    display:flex;gap:10px;align-items:center;justify-content:space-between;background:#f8f1e9;border:1px dashed #d4af37;border-radius:12px;padding:10px 12px
  }
  .promo-code{font-weight:900;font-size:1.2rem;color:var(--primary)}
  .small{opacity:.8;font-size:.92rem}
</style>
</head>
<body>
<div class="wrap">
  <div class="head">
    <div class="title" id="gameTitle">Sopa de letras culinaria</div>
    <button class="btn" id="restartBtn">Reiniciar</button>
  </div>

  <div class="grid-card">
    <div class="grid-wrap">
      <div class="grid" id="grid"></div>
      <div class="side">
        <div class="small" id="subtitle">Encuentra estas palabras:</div>
        <div class="word-list" id="wordList"></div>
        <div class="info" id="infoBox">Selecciona letras contiguas en lÃ­nea recta. Al acertar, te cuento una historia/mito del ingrediente.</div>
        <div class="stat" id="statBox">Progreso: <span id="foundCount">0</span>/<span id="totalCount">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal promo -->
<div class="modal" id="winModal">
  <div class="card">
    <h2 id="winTitle">ðŸŽ‰ Â¡Felicidades!</h2>
    <p id="winMsg" class="small">Has completado el reto. AquÃ­ tienes tu cÃ³digo promocional:</p>
    <div class="promo">
      <div class="promo-code" id="promoCode">XAT-ABC123</div>
      <button class="btn" id="copyBtn">Copiar</button>
    </div>
    <p class="small" id="winNote">Lo hemos guardado y se enviarÃ¡ junto a tu reserva.</p>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" id="closeWin">Cerrar</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ===== idioma por querystring =====
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || 'es').toLowerCase();
  const T = {
    es:{
      title:"Sopa de letras culinaria",
      find:"Encuentra estas palabras:",
      info:"Selecciona letras contiguas en lÃ­nea recta. Al acertar, te cuento una historia/mito del ingrediente.",
      progress:"Progreso:",
      winTitle:"ðŸŽ‰ Â¡Felicidades!",
      winMsg:"Has completado el reto. AquÃ­ tienes tu cÃ³digo promocional:",
      winNote:"Lo hemos guardado y se enviarÃ¡ junto a tu reserva.",
      copy:"Copiar",
      restart:"Reiniciar"
    },
    en:{
      title:"Culinary Word Search",
      find:"Find these words:",
      info:"Select contiguous letters in a straight line. When you find one, Iâ€™ll tell you a story/myth about it.",
      progress:"Progress:",
      winTitle:"ðŸŽ‰ Congrats!",
      winMsg:"You nailed it. Hereâ€™s your promo code:",
      winNote:"We saved it and will attach it to your booking.",
      copy:"Copy",
      restart:"Restart"
    },
    ca:{
      title:"Sopa de lletres culinÃ ria",
      find:"Troba aquestes paraules:",
      info:"Selecciona lletres contigÃ¼es en lÃ­nia recta. En encertar, et conte una histÃ²ria/mite de lâ€™ingredient.",
      progress:"ProgrÃ©s:",
      winTitle:"ðŸŽ‰ Enhorabona!",
      winMsg:"Ho has clavat. AcÃ­ tens el teu codi promocional:",
      winNote:"Lâ€™hem guardat i sâ€™adjuntarÃ  a la reserva.",
      copy:"Copiar",
      restart:"Reiniciar"
    }
  }[lang];

  // ===== UI textos =====
  document.getElementById('gameTitle').textContent = T.title;
  document.getElementById('subtitle').textContent = T.find;
  document.getElementById('infoBox').textContent = T.info;
  document.getElementById('winTitle').textContent = T.winTitle;
  document.getElementById('winMsg').textContent = T.winMsg;
  document.getElementById('winNote').textContent = T.winNote;
  document.getElementById('copyBtn').textContent = T.copy;
  document.getElementById('restartBtn').textContent = T.restart;

  // ===== Dataset de palabras + mini-lore (puedes ampliar a tu gusto; aquÃ­ 12) =====
  const WORDS = [
    { w:"ARROZ", lore:"El socarrat es el tesoro del fondo: textura crujiente y sabor concentrado." },
    { w:"AZAFRAN", lore:"Oro rojo: da color y aroma floral; tostar levemente potencia su magia." },
    { w:"FIDEUA", lore:"Nacida por azar en GandÃ­a cuando faltÃ³ arroz. Fideos tostados, sabor marino." },
    { w:"TOMATE", lore:"De sospechoso a rey de la huerta. En su dÃ­a se creyÃ³ venenoso en Europa." },
    { w:"AJO", lore:"Humilde y poderoso: base de sofritos y alioli; sabor que manda callar." },
    { w:"PIMENTON", lore:"Dulce o picante, ahumado o no: define chorizos, guisos y arroces." },
    { w:"CALAMAR", lore:"Aliado perfecto en arroces de mar; tierno con cocciÃ³n breve o larga." },
    { w:"ALMEJA", lore:"Aporta yodo y salinidad suave; abierta al vapor, pura elegancia." },
    { w:"ROMERO", lore:"Hierba mediterrÃ¡nea resina-pino; perfuma asados y patatas." },
    { w:"LIMON", lore:"Acidez luminosa; equilibra grasas y refresca marinados." },
    { w:"ACEITE", lore:"AOVE: frutado, amargo y picante â€” el triÃ¡ngulo de la calidad." },
    { w:"PAELLA", lore:"Icono valenciano: sofrito, caldo sabroso y reposo respetuoso." }
  ];

  // ===== Config del tablero =====
  const ROWS=12, COLS=12;
  const gridEl = document.getElementById('grid');
  const listEl = document.getElementById('wordList');
  const infoEl = document.getElementById('infoBox');
  const foundCountEl = document.getElementById('foundCount');
  const totalCountEl = document.getElementById('totalCount');
  const winModal = document.getElementById('winModal');
  const promoCodeEl = document.getElementById('promoCode');

  totalCountEl.textContent = WORDS.length;

  // Estado
  const grid = Array.from({length:ROWS}, ()=> Array(COLS).fill(null));
  const placed = [];
  const found = new Set();
  let selection = [];

  // Util
  const ABC = "ABCDEFGHIJKLMNÃ‘OPQRSTUVWXYZ";
  function rand(n){ return Math.floor(Math.random()*n); }
  function inBounds(r,c){ return r>=0 && r<ROWS && c>=0 && c<COLS; }
  function qs(sel){ return document.querySelector(sel); }

  // Colocar palabras en direcciones (H,V,D)
  const DIRS = [
    [0,1], [1,0], [1,1], [0,-1], [-1,0], [-1,-1], [1,-1], [-1,1]
  ];

  function placeAll(){
    // Limpia
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) grid[r][c]=null;
    placed.length=0; found.clear(); selection.length=0;

    // Coloca una a una
    for (const obj of WORDS){
      const W = obj.w.toUpperCase().replace(/Ã|Ã€/g,'A').replace(/Ã‰|Ãˆ/g,'E').replace(/Ã|ÃŒ/g,'I').replace(/Ã“|Ã’/g,'O').replace(/Ãš|Ã™/g,'U').replace(/Ã‘/g,'Ã‘');
      let ok=false, tries=0;
      while(!ok && tries<400){
        tries++;
        const dir = DIRS[rand(DIRS.length)];
        const r0 = rand(ROWS), c0 = rand(COLS);
        let r=r0,c=c0, valid=true;
        for (let i=0;i<W.length;i++){
          if(!inBounds(r,c)){ valid=false; break; }
          const cell = grid[r][c];
          if (cell && cell !== W[i]) { valid=false; break; }
          r+=dir[0]; c+=dir[1];
        }
        if (!valid) continue;
        // Coloca
        r=r0; c=c0;
        for (let i=0;i<W.length;i++){
          grid[r][c] = W[i];
          r+=dir[0]; c+=dir[1];
        }
        placed.push({w:W, start:[r0,c0], dir});
        ok=true;
      }
      if(!ok) console.warn('No pude colocar', obj.w);
    }

    // Rellena huecos
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
      if(!grid[r][c]) grid[r][c] = ABC[rand(ABC.length)];
    }
  }

  function draw(){
    gridEl.style.gridTemplateColumns = `repeat(${COLS}, 32px)`;
    gridEl.innerHTML = '';
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const div=document.createElement('div');
        div.className='cell';
        div.textContent=grid[r][c];
        div.dataset.r=r; div.dataset.c=c;
        gridEl.appendChild(div);
      }
    }

    // Lista palabras
    listEl.innerHTML='';
    for(const obj of WORDS){
      const b=document.createElement('button');
      b.className='word-item';
      b.dataset.word=obj.w;
      b.textContent=obj.w;
      listEl.appendChild(b);
    }

    foundCountEl.textContent = found.size;
  }

  function reset(){
    placeAll(); draw();
    infoEl.textContent = T.info;
    found.clear(); foundCountEl.textContent = found.size;
    winModal.classList.remove('show');
  }

  // SelecciÃ³n con ratÃ³n/tÃ¡ctil
  function cellAtEvent(e){
    const el = e.target.closest('.cell');
    if(!el) return null;
    return { el, r: +el.dataset.r, c: +el.dataset.c };
  }

  let isDown=false, start=null;
  gridEl.addEventListener('pointerdown', e=>{
    const info = cellAtEvent(e); if(!info) return;
    isDown=true; start=info; selection=[info];
    info.el.classList.add('selected');
  });
  gridEl.addEventListener('pointermove', e=>{
    if(!isDown) return;
    const info = cellAtEvent(e); if(!info) return;
    const last = selection[selection.length-1];
    if (last && (info.r !== last.r || info.c !== last.c)){
      selection.push(info);
      info.el.classList.add('selected');
    }
  });
  window.addEventListener('pointerup', ()=>{
    if(!isDown) return; isDown=false;
    checkSelection();
    selection.forEach(s=>s.el.classList.remove('selected'));
    selection=[];
  }, {passive:true});

  function checkSelection(){
    if (selection.length<2) return;
    // Derivar string y normalizar
    const s = selection.map(x=>x.el.textContent).join('').toUpperCase();
    const candidates = [s, [...selection].reverse().map(x=>x.el.textContent).join('').toUpperCase()];
    let hit = null;
    for(const cand of candidates){
      const foundWord = WORDS.find(o=>o.w === cand);
      if (foundWord && !found.has(foundWord.w)){
        hit = foundWord; break;
      }
    }
    if (!hit) return;

    // Marca celdas y palabra
    selection.forEach(x=>x.el.classList.add('found'));
    const item = [...document.querySelectorAll('.word-item')].find(b=>b.dataset.word===hit.w);
    if (item) item.classList.add('found');

    found.add(hit.w);
    foundCountEl.textContent = found.size;
    infoEl.textContent = hit.lore;

    // Win logic (umbral 7)
    if (found.size >= 7){
      const code = getOrCreatePromo();
      promoCodeEl.textContent = code;
      winModal.classList.add('show');

      // Comunicar al padre
      try{
        parent.postMessage({ type:'CULINARY_GAME_DONE', code, words:[...found], lang }, '*');
      }catch(e){}
    }
  }

  // Promo code
  function getOrCreatePromo(){
    const k='xativabot-game-promo';
    let v = localStorage.getItem(k);
    if (v) return v;
    v = 'XAT-' + Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,6);
    localStorage.setItem(k, v);
    return v;
  }

  // Botones
  document.getElementById('restartBtn').addEventListener('click', reset);
  document.getElementById('copyBtn').addEventListener('click', ()=>{
    const v = promoCodeEl.textContent.trim();
    navigator.clipboard?.writeText(v);
  });
  document.getElementById('closeWin').addEventListener('click', ()=> winModal.classList.remove('show'));

  // Start
  reset();
})();
</script>
</body>
</html>
