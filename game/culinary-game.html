<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#8B0000" />
<title>Sopa de Letras Gastron√≥mica ¬∑ Xativa</title>

<style>
  :root{
    --vino:#8B0000;
    --vino-2:#6f0000;
    --vino-3:#520000;
    --gold:#E5C44B;
    --card:#ffffff;
    --ink:#1a1a1a;
    --muted:#5c5c5c;
    --soft:#f8f1e9;
    --chip:#f7eae2;
    --green:#28a745;
    --sel:#f6e99a;
    --grid-bg:#fff6f6;
    --tile:#ffffff;
    --tile-b:#e6e6e6;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
    color:var(--ink); background:linear-gradient(180deg, #faf6f6 0%, #fff 20%, #fff 100%);
  }

  .wrap{
    max-width:1000px; margin:0 auto; padding:16px env(safe-area-inset-right) 32px env(safe-area-inset-left);
  }

  .hero{
    background:linear-gradient(160deg,var(--vino) 0%, var(--vino-2) 60%, var(--vino-3) 100%);
    color:#fff; border-radius:22px; padding:24px; box-shadow:0 10px 30px rgba(139,0,0,.25); margin-top:8px;
  }
  .hero h1{margin:0; font-size:clamp(22px,4.8vw,36px); line-height:1.2; text-align:center}
  .hero .sub{margin:10px auto 0; text-align:center; opacity:.95; max-width:50ch; font-weight:500}
  .underline{display:inline-block; height:4px; width:120px; background:var(--gold); border-radius:4px; margin:10px auto 0}

  .card{background:var(--card); border-radius:18px; box-shadow:0 8px 24px rgba(0,0,0,.08); border:1px solid #eee}
  .howto{margin:16px 0; padding:18px; border:2px solid rgba(139,0,0,.15)}
  .howto p{margin:0; color:#3b3b3b}
  .stats{margin:16px 0; padding:16px; display:grid; grid-template-columns:repeat(3,1fr); gap:8px; text-align:center}
  .stats .num{font-weight:800; font-size:clamp(20px,6vw,34px); color:var(--vino)}
  .stats small{color:var(--muted)}
  .progress{height:10px; background:#eee; border-radius:999px; overflow:hidden; margin:8px 16px 0}
  .bar{height:100%; width:0%; background:linear-gradient(90deg,var(--gold),#ffd43b); transition:width .25s ease}

  .boardWrap{margin:10px 0 18px; padding:14px; background:var(--grid-bg); border:2px dashed rgba(139,0,0,.2); border-radius:14px}
  .board{
    --size:16; /* cambia tama√±o del tablero si lo deseas */
    display:grid; grid-template-columns:repeat(var(--size), minmax(0,1fr)); gap:8px;
    touch-action:none; /* MEJORA t√°ctil: bloquea zoom/scroll mientras se arrastra selecci√≥n */
  }
  .cell{
    background:var(--tile); border:1px solid var(--tile-b); height:42px; border-radius:10px;
    display:flex; align-items:center; justify-content:center; font-weight:800; letter-spacing:.5px;
    font-size:20px; color:#2b2b2b; user-select:none; -webkit-user-select:none; position:relative;
    transition:transform .06s ease, background .12s ease, border-color .12s ease;
  }
  .cell.sel{background:var(--sel); border-color:#e8d46a}
  .cell.hit{background:#d2f7dc; border-color:#b9ebc6; color:#0e5e27}
  .cell:active{transform:scale(.98)}
  .legend{
    margin:18px 0; padding:18px; display:flex; flex-direction:column; gap:16px;
  }
  .legend h2{margin:0; text-align:center; color:var(--vino)}
  .chips{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:14px}
  .chip{
    padding:14px 18px; border-radius:999px; border:none; cursor:pointer; font-weight:800; letter-spacing:.5px;
    text-transform:uppercase; background:linear-gradient(160deg,var(--vino) 0%, var(--vino-2) 70%); color:#fff;
    box-shadow:0 10px 20px rgba(139,0,0,.2); outline:none;
  }
  .chip.done{background:linear-gradient(160deg,#1e9d52,#178b45); color:#fff}
  .chip:focus-visible{outline:3px solid #ffd43b}

  .footer{margin:22px 0 8px; text-align:center; color:#555}

  /* Modal historia */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:40; padding:18px}
  .modal.open{display:grid}
  .sheet{
    max-width:800px; width:100%; background:var(--card); border-radius:18px; padding:20px 18px 22px;
    border:3px solid var(--vino-2); box-shadow:0 18px 50px rgba(0,0,0,.35);
  }
  .sheet h3{margin:4px 0 8px; color:var(--vino); font-size:clamp(18px,4.6vw,28px)}
  .sheet p{margin:10px 0; line-height:1.75; font-size:18px}
  .closeX{position:absolute; right:16px; top:12px; background:#fff; border:2px solid var(--vino-2); color:var(--vino);
          width:34px; height:34px; border-radius:999px; font-weight:900; cursor:pointer}
  .promo{margin-top:12px; padding:14px; border-radius:14px; background:#fff8da; border:1px solid #f1e1a6; color:#5a4300}
  .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .btn{
    border:none; background:linear-gradient(160deg,var(--vino) 0%, var(--vino-2) 70%); color:#fff; padding:10px 14px; border-radius:10px;
    font-weight:700; cursor:pointer
  }
  .btn.alt{background:#1f8345}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding:2px 6px; background:#000; color:#fff; border-radius:6px}

  @media (max-width:720px){
    .board{gap:6px}
    .cell{height:38px; border-radius:9px; font-size:18px}
    .chips{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <h1 id="title">Sopa de Letras Gastron√≥mica</h1>
      <div class="underline"></div>
      <p class="sub" id="subtitle">Descubre ingredientes, especias y vegetales del mundo. Toca y arrastra para seleccionar.</p>
    </section>

    <section class="card howto">
      <p id="howto"><strong>C√≥mo jugar:</strong> Toca y arrastra suavemente para seleccionar palabras. Est√°n en cualquier direcci√≥n (‚Üî ‚Üï ‚Üó ‚Üò). Al encontrar una palabra se abrir√° su historia gastron√≥mica.</p>
    </section>

    <section class="card">
      <div class="stats">
        <div>
          <div class="num" id="foundNum">0</div>
          <small id="foundLabel">Encontradas</small>
        </div>
        <div>
          <div class="num" id="totalNum">0</div>
          <small id="totalLabel">Totales</small>
        </div>
        <div>
          <div class="num" id="pctNum">0%</div>
          <small id="pctLabel">Completado</small>
        </div>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>

      <div class="boardWrap">
        <div id="board" class="board" aria-label="Tablero"></div>
      </div>
    </section>

    <section class="card legend">
      <h2 id="toFindTitle">Ingredientes por descubrir</h2>
      <div id="wordsList" class="chips"></div>
    </section>

    <p class="footer" id="footerNote">Al completar las 7 primeras palabras recibir√°s un c√≥digo culinario de cortes√≠a.</p>
  </div>

  <!-- Modal de historia / fin -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="storyTitle">
    <div class="sheet">
      <button class="closeX" aria-label="Cerrar" onclick="toggleModal(false)">√ó</button>
      <h3 id="storyTitle">Historia</h3>
      <p id="storyText"></p>
      <div id="promoBox" class="promo" style="display:none"></div>
      <div class="btnRow">
        <button class="btn" onclick="toggleModal(false)" id="closeBtn">Cerrar</button>
        <button class="btn alt" onclick="copyPromo()" id="copyBtn" style="display:none">Copiar c√≥digo</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== i18n b√°sico ======
  const params = new URLSearchParams(location.search);
  const lang = (params.get('lang') || document.documentElement.lang || 'es').toLowerCase();
  const T = {
    es:{
      title:'Sopa de Letras Gastron√≥mica',
      subtitle:'Descubre ingredientes, especias y vegetales del mundo. Toca y arrastra para seleccionar.',
      howto:'<strong>C√≥mo jugar:</strong> Toca y arrastra suavemente para seleccionar palabras. Est√°n en cualquier direcci√≥n (‚Üî ‚Üï ‚Üó ‚Üò). Al encontrar una palabra se abrir√° su historia gastron√≥mica.',
      found:'Encontradas', total:'Totales', done:'Completado',
      toFind:'Ingredientes por descubrir',
      footer:'Al completar las 7 primeras palabras recibir√°s un c√≥digo culinario de cortes√≠a.',
      congrats:'üéâ ¬°Excelente! Has completado el reto. Tu c√≥digo promocional es:',
      copy:'Copiar c√≥digo', close:'Cerrar'
    },
    en:{
      title:'Culinary Word Search',
      subtitle:'Discover ingredients, spices and vegetables. Touch & drag to select.',
      howto:'<strong>How to play:</strong> Touch and drag gently to select words. They can be in any direction (‚Üî ‚Üï ‚Üó ‚Üò). Each word reveals a short culinary story.',
      found:'Found', total:'Total', done:'Completed',
      toFind:'Ingredients to discover',
      footer:'After 7 words you‚Äôll get a culinary courtesy code.',
      congrats:'üéâ Great! Challenge completed. Your promo code:',
      copy:'Copy code', close:'Close'
    },
    ca:{
      title:'Sopa de Lletres Gastron√≤mica',
      subtitle:'Descobreix ingredients, esp√®cies i verdures. Toca i arrossega per seleccionar.',
      howto:'<strong>Com jugar:</strong> Toca i arrossega suaument per seleccionar paraules. En qualsevol direcci√≥ (‚Üî ‚Üï ‚Üó ‚Üò). Cada paraula obri una breu hist√≤ria culin√†ria.',
      found:'Trobades', total:'Totals', done:'Completat',
      toFind:'Ingredients per descobrir',
      footer:'En completar 7 paraules rebr√†s un codi de cortesia culin√†ria.',
      congrats:'üéâ Genial! Repte completat. El teu codi promocional:',
      copy:'Copia el codi', close:'Tancar'
    }
  }[lang];

  // Pintar i18n
  document.getElementById('title').textContent = T.title;
  document.getElementById('subtitle').textContent = T.subtitle;
  document.getElementById('howto').innerHTML = T.howto;
  document.getElementById('foundLabel').textContent = T.found;
  document.getElementById('totalLabel').textContent = T.total;
  document.getElementById('pctLabel').textContent = T.done;
  document.getElementById('toFindTitle').textContent = T.toFind;
  document.getElementById('footerNote').textContent = T.footer;
  document.getElementById('closeBtn').textContent = T.close;
  document.getElementById('copyBtn').textContent = T.copy;

  // ====== Dataset de palabras (labels + historias) ======
  // key = colocaci√≥n (sin espacios/acentos), label = visible por idioma
  const WORDS = [
    W('CANELA',  {en:'CINNAMON', ca:'CANYELLA'}, s('La canela, corteza del canelo, perfuma postres y guisos desde la antig√ºedad √°rabe-andaluza. En paellas dulces hist√≥ricas era invitada frecuente.')),
    W('CILANTRO',{en:'CILANTRO', ca:'CILANTRE'}, s('De sabor c√≠trico-anisado, lleg√≥ de Asia y prendi√≥ en Am√©rica. En la fideu√† aporta un frescor inesperado.')),
    W('JENGIBRE',{en:'GINGER', ca:'GINGEBRE'}, s('Rizoma picante y medicinal. En marinados para pescados realza el umami y limpia el paladar.')),
    W('TOMATE',  {en:'TOMATO', ca:'TOM√ÄTIC'}, s('Emblema mediterr√°neo desde el siglo XVI. Frito lento con AOVE forma sofritos base de arroces.')),
    W('BERENJENA',{en:'EGGPLANT', ca:'ALBERG√çNIA'}, s('Asada al carb√≥n revela notas ahumadas ideales para salsas con piment√≥n y comino.')),
    W('QUINOA',  {en:'QUINOA', ca:'QUINOA'}, s('Grano andino sagrado. La NASA la consider√≥ alimento de astronautas por su prote√≠na completa.')),
    W('CURCUMA', {en:'TURMERIC', ca:'C√öRCUMA'}, s('Color dorado y notas terrosas. Potencia caldos de pescado y alioli emulsionado.')),
    W('AGUACATE',{en:'AVOCADO', ca:'ALVOCAT'}, s('Mantecoso y sutil. En tartares marinos aporta grasa noble y suaviza el picante.')),
    W('ALBAHACA',{en:'BASIL', ca:'ALF√ÄBREGA'}, s('Aroma verde y bals√°mico; la variedad genovesa reina en pestos y aceites perfumados.')),
    W('ROMERO',  {en:'ROSEMARY', ca:'ROMER'}, s('Matorral mediterr√°neo. Una rama al final del asado perfuma sin amargar.')),
    W('VAINILLA',{en:'VANILLA', ca:'VAINILLA'}, s('Orqu√≠dea arom√°tica de Mesoam√©rica. Su vaina guarda miles de semillas llenas de vainillina.')),
    W('NUEZMOSCADA',{en:'NUTMEG', ca:'NOU MOSCADA'}, s('Rallada al momento, redondea cremas y bechameles. Exceso amarga: una pizca basta.')),
    W('PIMIENTA',{en:'PEPPER', ca:'PEBRE'}, s('La ‚Äúreina de las especias‚Äù. Molida al instante libera pineno y limoneno muy vol√°tiles.')),
    W('COMINO',  {en:'CUMIN', ca:'COM√ç'}, s('Semilla c√°lida y terrosa. Casamiento perfecto con garbanzos, berenjena y yogur.')),
    W('OLIVO',   {en:'OLIVE TREE', ca:'OLIVERA'}, s('Del √°rbol al AOVE: frutado, amargo y picante deben estar en equilibrio‚Äîtr√≠o de oro.'))
  ];
  // Nota: puedes ajustar a 7 si quieres un reto m√°s corto
  const PROMO_THRESHOLD = 7;

  function s(es){ return {es, en:es, ca:es}; }
  function W(key, labels, story){ return { key:normalize(key), labels:{es:key, ...labels}, story }; }
  function normalize(str){ return str.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f\s]/g,''); }

  // ====== Generador de tablero ======
  const size = 16; // 16x16 otorga espacio para 15 palabras
  const boardEl = document.getElementById('board');
  boardEl.style.setProperty('--size', size);
  const grid = Array.from({length:size}, ()=> Array(size).fill(''));
  const dirs = [
    [0,1],[1,0],[0,-1],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]
  ];

  // colocar palabras
  const placements = [];
  for(const w of WORDS){
    placeWord(w.key);
  }
  function placeWord(word){
    const letters = word.split('');
    for(let attempts=0; attempts<400; attempts++){
      const dir = dirs[(Math.random()*dirs.length)|0];
      const r0 = (Math.random()*size)|0;
      const c0 = (Math.random()*size)|0;
      const r1 = r0 + dir[0]*(letters.length-1);
      const c1 = c0 + dir[1]*(letters.length-1);
      if (r1<0 || r1>=size || c1<0 || c1>=size) continue;
      // cabe y no colisiona
      let ok=true;
      for(let i=0;i<letters.length;i++){
        const r=r0+dir[0]*i, c=c0+dir[1]*i;
        const cell=grid[r][c];
        if (cell && cell!==letters[i]) { ok=false; break; }
      }
      if (!ok) continue;
      for(let i=0;i<letters.length;i++){
        const r=r0+dir[0]*i, c=c0+dir[1]*i;
        grid[r][c]=letters[i];
      }
      placements.push({word, r0,c0,dir, len:letters.length});
      return true;
    }
    return false;
  }

  // rellenar
  const ABC = "A√ÅBCDE√âFGHI√çJKLMN√ëO√ìPQRSTU√ö√úVWXYZ";
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      if (!grid[r][c]) grid[r][c] = ABC[(Math.random()*ABC.length)|0];
    }
  }

  // render
  const cells=[];
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const d=document.createElement('div');
      d.className='cell';
      d.textContent = grid[r][c];
      d.dataset.r=r; d.dataset.c=c;
      boardEl.appendChild(d);
      cells.push(d);
    }
  }

  // leyenda
  const listEl = document.getElementById('wordsList');
  WORDS.forEach((w,i)=>{
    const b=document.createElement('button');
    b.className='chip'; b.id='chip-'+w.key;
    b.type='button'; b.textContent = (w.labels[lang] || w.labels.es);
    listEl.appendChild(b);
  });

  // ====== Interacci√≥n t√°ctil: Pointer Events ======
  let dragging=false, pid=null, start=null, currentPath=[];
  boardEl.addEventListener('pointerdown', (e)=>{
    const t=e.target.closest('.cell'); if(!t) return;
    pid=e.pointerId; dragging=true; boardEl.setPointerCapture(pid);
    start = [ +t.dataset.r, +t.dataset.c ];
    currentPath = [t];
    t.classList.add('sel');
    e.preventDefault();
  }, {passive:false});

  boardEl.addEventListener('pointermove', (e)=>{
    if(!dragging || e.pointerId!==pid) return;
    const t=e.target.closest('.cell'); if(!t) return;
    const r=+t.dataset.r, c=+t.dataset.c;
    updateSelection(start[0], start[1], r, c);
    e.preventDefault();
  }, {passive:false});

  boardEl.addEventListener('pointerup', (e)=>{
    if(e.pointerId!==pid) return;
    finalizeSelection();
    dragging=false; pid=null; start=null; currentPath=[];
  });

  function updateSelection(r0,c0, r1,c1){
    // obliga selecci√≥n en l√≠nea recta (H, V, D)
    const dr = Math.sign(r1-r0), dc = Math.sign(c1-c0);
    if (!(dr===0 || dc===0 || Math.abs(r1-r0)===Math.abs(c1-c0))) return;

    // limpiar selecci√≥n previa
    currentPath.forEach(el=> el.classList.remove('sel'));
    currentPath = [];

    let r=r0, c=c0;
    while(true){
      const el = queryCell(r,c);
      if (el){ el.classList.add('sel'); currentPath.push(el); }
      if (r===r1 && c===c1) break;
      r+=dr; c+=dc;
    }
  }
  function queryCell(r,c){
    return boardEl.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
  }

  // ====== L√≥gica de acierto ======
  const foundSet = new Set();
  const foundWords = new Set();
  const foundNumEl = document.getElementById('foundNum');
  const totalNumEl = document.getElementById('totalNum');
  const pctNumEl = document.getElementById('pctNum');
  const barEl = document.getElementById('bar');
  totalNumEl.textContent = WORDS.length;

  function finalizeSelection(){
    if (!currentPath.length) return;
    const letters = currentPath.map(el=> el.textContent.toUpperCase()).join('');
    const reversed = letters.split('').reverse().join('');
    const match = matchWord(letters) || matchWord(reversed);
    if (match){
      // marcar
      currentPath.forEach(el=> el.classList.remove('sel'));
      currentPath.forEach(el=> el.classList.add('hit'));
      foundWords.add(match);
      // marcar chip
      const chip=document.getElementById('chip-'+match);
      if (chip) chip.classList.add('done');
      // historia
      showStory(match);
      // progreso
      const n = foundWords.size;
      foundNumEl.textContent = n;
      const pct = Math.round(n*100/WORDS.length);
      pctNumEl.textContent = pct+'%';
      barEl.style.width = pct+'%';

      // promo al llegar al umbral
      if (!hasPromo() && n>=PROMO_THRESHOLD){
        const code = makePromo();
        saveGame({completed:false, words:[...foundWords], promoCode:code});
        // mostrar aviso dentro del modal actual
        showPromo(code, true);
      }else{
        saveGame({completed:foundWords.size===WORDS.length, words:[...foundWords], promoCode:getPromo()});
      }
    }else{
      // limpiar si no hay match
      currentPath.forEach(el=> el.classList.remove('sel'));
    }
  }

  function matchWord(seq){
    const norm = normalize(seq);
    const item = WORDS.find(w => w.key===norm);
    return item ? item.key : null;
  }

  // ====== Historias / Modal ======
  function showStory(key){
    const item = WORDS.find(w=> w.key===key);
    if (!item) return;
    const title = item.labels[lang] || item.labels.es;
    const text  = item.story[lang] || item.story.es;

    document.getElementById('storyTitle').textContent = `üç∑ ${title}`;
    document.getElementById('storyText').textContent  = text;
    document.getElementById('promoBox').style.display='none';
    document.getElementById('copyBtn').style.display='none';
    toggleModal(true);
  }
  window.toggleModal = (open) => {
    document.getElementById('modal').classList.toggle('open', !!open);
  }

  // ====== Promo & storage ======
  function makePromo(){
    const rand = Math.random().toString(36).slice(2,6).toUpperCase();
    const d = new Date();
    const stamp = String(d.getFullYear()).slice(2)+(""+(d.getMonth()+1)).padStart(2,'0')+(""+d.getDate()).padStart(2,'0');
    const code = `XATIVA-${stamp}-${rand}`;
    return code;
  }
  function showPromo(code, fromWin=false){
    const box = document.getElementById('promoBox');
    box.innerHTML = `<strong>${T.congrats}</strong> <span class="kbd">${code}</span><br>
      <small>Se guard√≥ autom√°ticamente y se a√±adir√° a tu reserva.</small>`;
    box.style.display='block';
    const copyBtn=document.getElementById('copyBtn'); copyBtn.style.display='inline-block';
    if (!fromWin) toggleModal(true);
  }
  function saveGame({completed, words, promoCode}){
    const data = {
      lang, completed, promoCode: promoCode || null, words,
      finishedAt: new Date().toISOString()
    };
    localStorage.setItem('xativabot-game', JSON.stringify(data));
    // evento para integrarse con la app (si est√° embebido mismo dominio)
    try{ window.dispatchEvent(new CustomEvent('xativabot-game-finished',{detail:data})); }catch{}
  }
  function getPromo(){
    try{
      const d=JSON.parse(localStorage.getItem('xativabot-game')||'{}');
      return d.promoCode||null;
    }catch{ return null; }
  }
  function hasPromo(){ return !!getPromo(); }

  window.copyPromo = () => {
    const d=JSON.parse(localStorage.getItem('xativabot-game')||'{}');
    if (!d.promoCode) return;
    navigator.clipboard?.writeText(d.promoCode).then(()=>{
      alert('C√≥digo copiado');
    });
  };

  // Si ya hab√≠a progreso, aplicar chips y mostrar promo
  (function hydrate(){
    try{
      const d=JSON.parse(localStorage.getItem('xativabot-game')||'{}');
      if (d?.words?.length){
        d.words.forEach(k=>{
          const chip=document.getElementById('chip-'+k);
          if (chip) chip.classList.add('done');
          foundWords.add(k);
        });
        const n=foundWords.size; foundNumEl.textContent=n;
        totalNumEl.textContent=WORDS.length;
        const pct=Math.round(n*100/WORDS.length);
        pctNumEl.textContent=pct+'%'; barEl.style.width=pct+'%';
      }
      if (d?.promoCode) showPromo(d.promoCode);
    }catch{}
  })();

})();
</script>
</body>
</html>
